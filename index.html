<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Testing!</title>     <!-- Title of webpage -->           
	
		
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"/>   <!-- Leafet CSS --> 
		<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>   <!--Leaflet js --> 
		
		<script src='https://unpkg.com/@turf/turf@6.3.0/turf.min.js'></script>   <!-- Turf js --> 
		
		<link rel="stylesheet" href="./leaflet-compass-master/dist/leaflet-compass.min.css" /> <!-- Leaflet compass CSS -->
		<script src='./leaflet-compass-master/dist/leaflet-compass.min.js'></script> <!-- Leaflet compass js -->
		
		<link rel="stylesheet" href="./leaflet-sidebar-master/src/L.Control.Sidebar.css" /> <!-- Leaflet sidebar  V1 CSS -->
		<script src='./leaflet-sidebar-master/src/L.Control.Sidebar.js'></script> <!-- Leaflet sidebar V1 js -->
		
		<link rel="stylesheet" href="./Leaflet.Legend-master/src/leaflet.legend.css" /> <!-- Leaflet legend CSS -->
		<script src='./Leaflet.Legend-master/src/leaflet.legend.js'></script> <!-- Leaflet legend js -->
		
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />  <!-- Change size to fit mobile browser --> 
		
		<style>
	  
      /* set the web page to full size */
			html, body {
				padding:0;
				margin: 0;
				width: 100%;
				height: 100%;
			}

      /* set the map to full page */
			#map {
				width: 100%;
				height: 85%;
			}

		</style>
	
	</head>
	
	<body style="background-color: MidnightBlue"> <!-- background colour --> 
	
	<body>
		
		<div id="sidebar">                  <!-- Sidebar (currently has only Goatfell in it) --> 
			<h1> Congratulations! You have reached Goatfell </h1>             <!-- Heading -->
			<p> Goat Fell (marked as Goatfell by the Ordnance Survey; Scottish Gaelic: Gaoda Bheinn) is the highest point on the Isle of Arran. At 874 metres (2,867 ft), it is one of four Corbetts on the island. The mountain, along with nearby Brodick Castle, is now owned by the National Trust for Scotland.The name is believed to mean 'Goat Mountain' (from the Norse geita).  </p> 
			<img src= "goatfell_DTM.jpg" alt = "Goatfell" width = "380" height = "380"> <!-- Add images like this -->
			<p> Some information about Arran geology here </p> 
			<img src= "Goatfell_NE.jpg" alt= "Corries" width= "380" height= "380">
			<P> These maps display corries, glacial features </p> 
		</div> 
		
		<h1 style= 'font-size: 20px; font-family: Arial; color:white; text-align: center; margin-bottom: -10px'>A location based game</h1>     <!--style changes the look of the text-->                          
		<p style='font-size:20px; font-family: Arial; color:white'>Sites visited:</p>
		<p style='font-size:20 px; color:white; font-family: Arial'id="score"></p>			<!--Score-->
		<div id='map'></div>        <!--Map-->
		
		<div id="sidebar_two">                  <!-- Sidebar two --> 
			<h1> Settings </h1> 				<!-- currently contains miscellaneous stuff --> 
			<p> How to play: </p> 
			<p> 1. Navigate to sites <br> 2. Information about the sites will be shown when in close proximity <br> 3. Collect all the sites to win!</p> 
			<hr> 
			<p> Something else </p>
		</div> 
		
	
		<button id="toggle">Toggle Sidebar</button>
		<p id="demo"></p> 
		
		<script>
			
			var loc = null;  // Location variable       
			
			//COUNTER FOR SCORING SYSTEM 					
			let geofence_tracker = [0,0,0,0,0,0];  // Create array with each geofence set to zero 
			
			
			//alert("welcome to the Isle of Arran! \n In order to continue please enable location ");     //Alert shown when webpage is opened 
			
			var myStyle = {     // Style for geofences 
				"color": "FF0000",
				"weight": 5,
				"opacity": 0.35
			};
			
			
			//CREATE MAP 
			const map = L.map('map');
			const mapCentre = L.latLng(53.805136, -1.840275);
			map.setView(mapCentre, 14);
			const tiles = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'});
			tiles.addTo(map); // Add tiles to map 
			
			// ADD LOCATE 
			map.locate({setView: false, maxZoom: 14, watch: true});			//Add geolocation watch = true means location is constantly watched rather than detected once  
	
			//ADD COMPASS 
			map.addControl( new L.Control.Compass({ position: 'topleft', showDigit:true}) );   // Add compass to map (using plugin)  

			// ADD SIDEBAR TO DISPLAY INFORMATION ABOUT SITES 
			var sidebar = L.control.sidebar ('sidebar', {         // Add sidebar to map 
				position: 'left'
			}); 
			map.addControl(sidebar); 
			
			// ADD SIDEBAR WITH ADDITIONAL INFORMATION 
			var sidebar_two = L.control.sidebar('sidebar_two', {
				position: 'right' 
			}); 
			map.addControl(sidebar_two); 
			
			document.getElementById("toggle").onclick = Toggle; 
			
			function Toggle () { 
				document.getElementById("demo").innerHTML = sidebar_two.toggle(); 
			}
			
			
			///////FUNCTION FOR GEOLOCATION//////////
			function onLocationFound(e) {                 // Create function for geolocation
				var radius = e.accuracy;
				
				geopoint = turf.point([e.latlng.lng, e.latlng.lat]);		//Create turf point at geolocation 	 
				
				var redIcon = L.icon({    //create icon  
					iconUrl: 'youarehere.png',  //https://www.flaticon.com/search?word=you%20are%20here  //icon URL 
					iconSize: [37,37],    // Size of icon 
					iconAnchor: [17, 37],  // icon (usually half and same)
					popupAnchor: [0,-37],
				})
				
				if (loc == null) {                        // Create a new marker
					loc = L.marker(e.latlng, {icon:redIcon}).addTo(map);
				} else { 
					loc.setLatLng(e.latlng); // update marker as position changes
				}
				
				//USE FOR LOOP TO CHECK IF CURRENT LOCATION IS WITHIN OUTER GEOFENCE (AND THEREFORE PROVIDES DIRECTIONS)
				const outerbufferList = [outer_geofence6, outer_geofence5, outer_geofence4, outer_geofence3, outer_geofence2, outer_geofence1];      // Store poly(buffers) in an array 
				for ( let i = 0; i < outerbufferList.length; i++) {      // For each item in the array 
					if (turf.booleanWithin(geopoint, outerbufferList[i])) {						// if current location is within geofence
						loc.bindPopup("<b>Getting close!</b><br> In the future directions will appear here").openPopup();		// add a popup to the marker created on line 54  
					}  
				}
				
				//USE FOR LOOP TO CHECK IF CURRENT LOCATION IS WITHIN INNER GEOFENCE (AND THEREFORE PROVIDES INFORMATION ABOUT SITE)
				const innerbufferList = [inner_geofence1,inner_geofence2, inner_geofence3, inner_geofence4, inner_geofence5, inner_geofence6];      // Store poly(buffers) in an array
				const marker = [g, ds, cs, gr, hc, kd];  // Array of geosite markers 
				for ( let i = 0; i < innerbufferList.length; i++) {      // For each item in the array 
					if (turf.booleanWithin(geopoint, innerbufferList[i])) {					// if current location is within geofence
						marker[i].bindPopup("Well done you found the site!").openPopup();     // Add a popup to the relevant marker 
						if ( geofence_tracker [i] == 0) {     // If current geofence tracker value is 0 
							geofence_tracker[i] = 1; 		// Change tracker to 1 
							points = 0;      //Add point to rewards  
							for(let j in geofence_tracker) { points += geofence_tracker[j]; } // for each site in geofence  tracker, points = geofence tracker 
							document.getElementById("score").innerHTML = points; //Display rewards on interface 
							sidebar.show();                              // Show sidebar when in geofence 
							marker[i].on('click', function () {    // Click marker to show sidebar in case it gets closed 
								sidebar.show();  
							}); 
							}  // bracket for nested if statement
					} else { 
					}
				}
			}
			
			/////ICON CLASS FOR CUSTOM ICONS////
			var arranIcon = L.Icon.extend({
				options: {
					iconSize: [37,37],   //Set icon size 
					iconAnchor: [26, 37], // Set icon anchor
					popupAnchor: [-5, -37] // Set popup anchor 
				}
			});
			 
			var goatfell = new arranIcon({iconUrl:'mountain.png'}),       // Remember to reference icons in final thing
				drumadoonsill = new arranIcon({iconUrl: 'landslide.png'}),  // Add each new icon to class using URL 
				corriesandstone = new arranIcon({iconUrl: 'sailboat.png'}),
				glenrosa = new arranIcon({iconUrl: 'river.png'}),
				huttonsunconformity = new arranIcon({iconUrl: 'tower.png'}),
				kildonandykes = new arranIcon({iconUrl: 'sunset.png'}); // Semi colon on last one
			
			//CREATE FIRST SITE//							
			var site_one = turf.point([-1.833031,53.805585]);					 // Turf point 
			let inner_geofence1 = turf.buffer(site_one, 0.05, {units: 'miles', steps: 32}); 	// Add inner buffer //Change steps to make buffer rounder 
			let outer_geofence1 = turf.buffer(site_one, 0.1, {units: 'miles', steps: 32}); // Add outer buffer 
			var g = L.marker([53.805585,-1.833031], {icon:goatfell}).bindPopup("Goatfell").addTo(map);     // Add custom icons as regular markers (didnt really need turf for this bit)
			L.geoJSON(inner_geofence1).addTo(map); 									// Add inner buffer to map 
			L.geoJSON(outer_geofence1, {style: myStyle}).addTo(map); 			// Add outer buffer with style 
				
			//CREATE SECOND SITE///
			var site_two = turf.point([-1.833460,53.813846]);					 // Turf point 
			let inner_geofence2 = turf.buffer(site_two, 0.1, {units: 'miles', steps:32}); 	// Add inner buffer
			let outer_geofence2 = turf.buffer(site_two, 0.1, {units: 'miles', steps:32}); // Add outer buffer 
			var ds = L.marker([53.813846,-1.833460], {icon:drumadoonsill}).bindPopup("Drumadoon Sill").addTo(map); // Add custom icon as regular marker 
			L.geoJSON(inner_geofence2).addTo(map); 									// Add inner buffer to map 
			L.geoJSON(outer_geofence2, {style: myStyle}).addTo(map); 			// Add outer buffer to map with style 
				
				
			//CREATE THIRD SITE//
			var site_three  = turf.point([-1.848824, 53.816050]); // Turf point 
			let inner_geofence3 = turf.buffer(site_three, 0.1, {units:'miles', steps:32}); // Add inner buffer 
			let outer_geofence3 = turf.buffer(site_three, 0.1, {units: 'miles',steps:32 }); // Add outer buffer
			var cs = L.marker([53.816050,-1.848824], {icon:corriesandstone}).bindPopup("Corrie sandstone").addTo(map); // Add custom icon 
			L.geoJSON(inner_geofence3).addTo(map); 										// Add inner buffer to map 
			L.geoJSON(outer_geofence3, {style: myStyle}).addTo(map); 				// Add outer buffer to map using style
				 
				
			///CREATE FORTH SITE////////
			var site_four  = turf.point([ -1.855304, 53.806041]);               // Turf point
			let inner_geofence4 = turf.buffer(site_four, 0.1, {units:'miles',steps:32});   // Add inner buffer 
			let outer_geofence4 = turf.buffer(site_four, 0.1,{units: 'miles',steps:32});    // Add outer buffer
			var gr = L.marker([53.806041,-1.855304], {icon:glenrosa}).bindPopup("Glen Rosa").addTo(map);  // Add custom icon 
			L.geoJSON(inner_geofence4).addTo(map); 										// Add inner buffer to map 
			L.geoJSON(outer_geofence4, {style: myStyle}).addTo(map); 				// Add outer buffer to map using style defined above 
				 
				
			///////CREATE FIFTH SITE////////
			var site_five  = turf.point([-1.831529,53.818457]);               // Turf point
			let inner_geofence5 = turf.buffer(site_five, 0.1, {units:'miles', steps:32});   // Add inner buffer 
			let outer_geofence5 = turf.buffer(site_five, 0.1,{units: 'miles', steps:32});    // Add outer buffer
		    var hc = L.marker([53.818457, -1.831529], {icon: huttonsunconformity}).bindPopup("Hutton's Unconformity").addTo(map); //Add custom icon   
			L.geoJSON(inner_geofence5).addTo(map); 										// Add inner buffer to map 
			L.geoJSON(outer_geofence5, {style: myStyle}).addTo(map); 				// Add outer buffer to map using style defined above
				
				
			////CREATE SIXTH SITE///////
			var site_six  = turf.point([-1.826278, 53.810118]);               // Turf point
			let inner_geofence6 = turf.buffer(site_six, 0.1, {units:'miles', steps:32});   // Add inner buffer 
			let outer_geofence6 = turf.buffer(site_six, 0.1,{units: 'miles', steps:32});    // Add outer buffer
			var kd = L.marker([53.810118,-1.826278], {icon: kildonandykes}).bindPopup("Kildonan Dykes").addTo(map);  // Add custom icon
			L.geoJSON(inner_geofence6).addTo(map); 										// Add inner buffer to map 
			L.geoJSON(outer_geofence6, {style: myStyle}).addTo(map); 				// Add outer buffer to map using style defined above 
							
			// CALL LOCATION FUNCTION 		
			map.on('locationfound', onLocationFound); 
			
			// ADD FAILED GEOLOCATION FUNCTION 
			function onLocationError(e) {     // Add function in the event of failed geolocation //seems to work even if location is found ? 
				alert(e.message); 
			} 
			map.on('locationerror', onLocationError); 
			
			//ADD LEGEND 
			L.control.Legend({           // Add legend to map 
				position: "bottomright", 
				legends: [{ 
					label : "Goatfell", 
					type: "image", 
					url: "mountain.png",  
				}]
			}).addTo(map); 
	</script>
	</body>
</html>
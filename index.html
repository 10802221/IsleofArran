<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Testing!</title>     <!-- Title of webpage -->           
	
		
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"/>   <!-- Leafet CSS --> 
		<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>   <!--Leaflet js --> 
		
		<script src='https://unpkg.com/@turf/turf@6.3.0/turf.min.js'></script>   <!-- Turf js --> 
		
		<link rel="stylesheet" href="./leaflet-compass-master/dist/leaflet-compass.min.css" /> <!-- Leaflet compass CSS -->
		<script src='./leaflet-compass-master/dist/leaflet-compass.min.js'></script> <!-- Leaflet compass js -->
		
		<link rel="stylesheet" href="./leaflet-sidebar-master/src/L.Control.Sidebar.css" /> <!-- Leaflet sidebar  V1 CSS -->
		<script src='./leaflet-sidebar-master/src/L.Control.Sidebar.js'></script> <!-- Leaflet sidebar V1 js -->
		
		<link rel="stylesheet" href="./Leaflet.Legend-master/src/leaflet.legend.css" /> <!-- Leaflet legend CSS -->
		<script src='./Leaflet.Legend-master/src/leaflet.legend.js'></script> <!-- Leaflet legend js -->
		
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />  <!-- Change size to fit mobile browser --> 
		
		<style>
	  
      /* set the web page to full size */
			html, body {
				padding:0;
				margin: 0;
				width: 100%;
				height: 100%;
			}

      /* set the map to full page */
			#map {
				width: 100%;
				height: 85%;
			}
			
			#toggle {
				line-height: 30px;
				width: 60px; 
				margin-top: 50px;
				margin-right: 60px;
				position: absolute;
				top: 0;
				right: 0; 
				background-color: white; 
			}
			
		</style>
	
	</head>
	
	<body style="background-color: MidnightBlue"> <!-- background colour --> 
	
	<body>
		
		<h1 style= 'font-size: 20px; font-family: Arial; color:white; text-align: center; margin-bottom: -10px'>A location based game</h1>     <!--style changes the look of the text-->                          
		
		<button type= "button" id= "toggle">Settings</button>   <!-- Create button to toggle sidebar -->
		
		<br>    <!-- Create some space between title and map --> 
		<br> 
		<br>
		<br> 
		
		<div id='map'></div>        <!--Map-->
		
		
		<div id="sidebar_settings">                  <!-- Sidebar --> 
			<h1> Settings </h1> 				<!-- currently contains miscellaneous stuff --> 
			<p><b> Sites visited:</b></p>
			<p id="score"></p>
			<hr>
			<p> How to play: </p> 
			<p> 1. Navigate to sites <br> 2. Information about the sites will be shown when in close proximity <br> 3. Collect all the sites to win!</p> 
		</div> 
		

		<script>
			
			var loc = null;  // Location variable       
			
			//COUNTER FOR SCORING SYSTEM 					
			let geofence_tracker = [0,0,0,0,0,0];  // Create array with each geofence set to zero 
			
			
			//alert("welcome to the Isle of Arran! \n In order to continue please enable location ");     //Alert shown when webpage is opened 
			
			var myStyle = {     // Style for geofences 
				"color": "FF0000",
				"weight": 5,
				"opacity": 0.35
			};
			
			
			//CREATE MAP 
			const map = L.map('map');
			const mapCentre = L.latLng(53.792502, -1.755063);
			map.setView(mapCentre, 14);
			const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'});
			tiles.addTo(map); // Add tiles to map 
			
			// ADD LOCATE 
			map.locate({setView: false, maxZoom: 14, watch: true});			//Add geolocation watch = true means location is constantly watched rather than detected once  
	
			//ADD COMPASS 
			map.addControl( new L.Control.Compass({ position: 'topleft', autoActive: true, showDigit: true}));   // Add compass to map (using plugin)  
			
			// ADD SIDEBAR WITH SETTINGS INFORMATION 
			var sidebar_settings = L.control.sidebar('sidebar_settings', {
				position: 'right' 
			}); 
			map.addControl(sidebar_settings);    // Add sidebar 
			
			document.getElementById("toggle").onclick = Toggle; // Link toggle button to sidebar 
			
			function Toggle () { 
				sidebar_settings.toggle(); // Function to toggle sidebar 
			}
			
			///////FUNCTION FOR GEOLOCATION//////////
			function onLocationFound(e) {                 // Create function for geolocation
				var radius = e.accuracy;
				
				geopoint = turf.point([e.latlng.lng, e.latlng.lat]);		//Create turf point at geolocation 	 
				
				var redIcon = L.icon({    //create icon  
					iconUrl: 'youarehere.png',  //https://www.flaticon.com/search?word=you%20are%20here  //icon URL 
					iconSize: [37,37],    // Size of icon 
					iconAnchor: [17, 37],  // icon (usually half and same)
					popupAnchor: [0,-37],
				})
				
				if (loc == null) {                        // Create a new marker
					loc = L.marker(e.latlng, {icon:redIcon}).addTo(map);
				} else { 
					loc.setLatLng(e.latlng); // update marker as position changes
				}
				
				//USE FOR LOOP TO CHECK IF CURRENT LOCATION IS WITHIN OUTER GEOFENCE (AND THEREFORE PROVIDES DIRECTIONS)
				const outerbufferList = [outer_geofence6, outer_geofence5, outer_geofence4, outer_geofence3, outer_geofence2, outer_geofence1];      // Store poly(buffers) in an array 
				for ( let i = 0; i < outerbufferList.length; i++) {      // For each item in the array 
					if (turf.booleanWithin(geopoint, outerbufferList[i])) {						// if current location is within geofence
						loc.bindPopup("<b>Getting close!</b><br> In the future directions will appear here").openPopup();		// add a popup to the marker created on line 54  
					}  
				}
				
				//USE FOR LOOP TO CHECK IF CURRENT LOCATION IS WITHIN INNER GEOFENCE (AND THEREFORE PROVIDES INFORMATION ABOUT SITE)
				const innerbufferList = [inner_geofence1,inner_geofence2, inner_geofence3, inner_geofence4, inner_geofence5, inner_geofence6];      // Store poly(buffers) in an array
				
				const popups = [g_popup, ds_popup, cs_popup, gr_popup, hc_popup, kd_popup];   // Array of markers (with popups attached) 
				
				for ( let i = 0; i < innerbufferList.length; i++) {      // For each item in the array 
					if (turf.booleanWithin(geopoint, innerbufferList[i])) {					// if current location is within geofence
						popups[i].openPopup();     //Open relevant popup 
						if ( geofence_tracker [i] == 0) {     // If current geofence tracker value is 0 
							geofence_tracker[i] = 1; 		// Change tracker to 1 
							points = 0;      //Add point to rewards  
							for(let j in geofence_tracker) { points += geofence_tracker[j]; } // for each site in geofence  tracker, points = geofence tracker 
							document.getElementById("score").innerHTML = points; //Display rewards on interface 
						}
					}  
				} 
			}
			
			
			
			/////ICON CLASS FOR CUSTOM ICONS////
			var arranIcon = L.Icon.extend({
				options: {
					iconSize: [37,37],   //Set icon size 
					iconAnchor: [26, 37], // Set icon anchor
					popupAnchor: [-5, -37] // Set popup anchor 
				}
			});
			 
			var goatfell = new arranIcon({iconUrl:'mountain.png'}),       // <div>Icons made by <a href="https://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
				drumadoonsill = new arranIcon({iconUrl: 'moher-cliffs.png'}), // <div>Icons made by <a href="https://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>  
				corriesandstone = new arranIcon({iconUrl: 'zen-rocks-stack.png'}),  // <div>Icons made by <a href="https://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
				glenrosa = new arranIcon({iconUrl: 'river.png'}),                  // <div>Icons made by <a href="https://www.freepik.com" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
				huttonsunconformity = new arranIcon({iconUrl: 'tower.png'}), 
				kildonandykes = new arranIcon({iconUrl: 'sunset.png'}); // Semi colon on last one
			
			//CREATE FIRST SITE//	//GOATFELL    						
			var site_one = turf.point([-1.747301,53.793542]);					 // Turf point 
			let inner_geofence1 = turf.buffer(site_one, 0.1, {units: 'miles', steps: 32}); 	// Add inner buffer //Change steps to make buffer rounder 
			let outer_geofence1 = turf.buffer(site_one, 0.1, {units: 'miles', steps: 32}); // Add outer buffer 
			var g = L.marker([53.793542, -1.747301], {icon:goatfell}).addTo(map);     // Add custom icons as regular markers (didnt really need turf for this bit)
			L.geoJSON(inner_geofence1).addTo(map); 									// Add inner buffer to map 
			L.geoJSON(outer_geofence1, {style: myStyle}).addTo(map); 			// Add outer buffer with style 
			//create content for Goatfell 
			var g_popupContent = ("<b> Well done! You found Goatfell! </b> <p>Big mountain</p> <img src= 'goatfell.jpg'/>")   //Add content using HTML tags 
			var g_popup = g.bindPopup(g_popupContent, { 
				maxWidth: "auto"  // Makes sure popups accomadate photos 
			});    
			
			
			//CREATE SECOND SITE//    //Drumadoon Sill 
			var site_two = turf.point([ -1.749468,53.795779]);					 // Turf point 
			let inner_geofence2 = turf.buffer(site_two, 0.1, {units: 'miles', steps:32}); 	// Add inner buffer
			let outer_geofence2 = turf.buffer(site_two, 0.1, {units: 'miles', steps:32}); // Add outer buffer 
			var ds = L.marker([53.795779,-1.749468], {icon:drumadoonsill}).addTo(map); // Add custom icon as regular marker 
			L.geoJSON(inner_geofence2).addTo(map); 									// Add inner buffer to map 
			L.geoJSON(outer_geofence2, {style: myStyle}).addTo(map); 			// Add outer buffer to map with style 
			//Create content for Drumadoon Sill 	
			var ds_popupContent = ("<b> Well done! You found Drumadoon Sill! </b> <p>Big Cliff</p> <img src= 'sill.jpg'/>")   //Add content using HTML tags 
			var ds_popup = ds.bindPopup(ds_popupContent, { 
				maxWidth: "auto"  // Makes sure popups accomadate photos 
			});


			//CREATE THIRD SITE//     //Corrie Sandstone 
			var site_three  = turf.point([-1.756825,53.797757]); // Turf point 
			let inner_geofence3 = turf.buffer(site_three, 0.1, {units:'miles', steps:32}); // Add inner buffer 
			let outer_geofence3 = turf.buffer(site_three, 0.1, {units: 'miles',steps:32 }); // Add outer buffer
			var cs = L.marker([53.797757,-1.756825], {icon:corriesandstone}).addTo(map); // Add custom icon 
			L.geoJSON(inner_geofence3).addTo(map); 										// Add inner buffer to map 
			L.geoJSON(outer_geofence3, {style: myStyle}).addTo(map); 				// Add outer buffer to map using style
			//Create content for Corrie Sandstone 
			var cs_popupContent = ("<b> Well done! You found Corrie Sandstone! </b> <p>Red rocks</p> <img src= 'sandstone.jpg'/>")   //Add content using HTML tags 
			var cs_popup = cs.bindPopup(cs_popupContent, { 
				maxWidth: "auto"  // Makes sure popups accomadate photos 
			});
				
			//CREATE FORTH SITE// 	//Glen Rosa
			var site_four  = turf.point([-1.772531, 53.801351]);               // Turf point
			let inner_geofence4 = turf.buffer(site_four, 0.1, {units:'miles',steps:32});   // Add inner buffer 
			let outer_geofence4 = turf.buffer(site_four, 0.1,{units: 'miles',steps:32});    // Add outer buffer
			var gr = L.marker([53.801351,-1.772531], {icon:glenrosa}).bindPopup("Glen Rosa").addTo(map);  // Add custom icon 
			L.geoJSON(inner_geofence4).addTo(map); 										// Add inner buffer to map 
			L.geoJSON(outer_geofence4, {style: myStyle}).addTo(map); 				// Add outer buffer to map using style defined above 
			// Create content for Glen Rosa
			var gr_popupContent = ("<b> Well done! You found Glen Rosa! </b> <p>Big valley</p> <img src= 'glenrosa.jpg'/>")   //Add content using HTML tags 
			var gr_popup = gr.bindPopup(gr_popupContent, { 
				maxWidth: "auto"  // Makes sure popups accomadate photos 
			});

				
			//CREATE FIFTH SITE//	//Hutton's Unconformity 
			var site_five  = turf.point([-1.754110,53.785572]);               // Turf point
			let inner_geofence5 = turf.buffer(site_five, 0.1, {units:'miles', steps:32});   // Add inner buffer 
			let outer_geofence5 = turf.buffer(site_five, 0.1,{units: 'miles', steps:32});    // Add outer buffer
		    var hc = L.marker([53.785572,-1.754110], {icon: huttonsunconformity}).bindPopup("Hutton's Unconformity").addTo(map); //Add custom icon   
			L.geoJSON(inner_geofence5).addTo(map); 										// Add inner buffer to map 
			L.geoJSON(outer_geofence5, {style: myStyle}).addTo(map); 				// Add outer buffer to map using style defined above
			//Create content for Huttons unconformity 
			var hc_popupContent = ("<b> Well done! You found Huttons Unconformity! </b> <p>Scientific breakthrough</p> <img src= 'hutton.jpg'/>")   //Add content using HTML tags 
			var hc_popup = hc.bindPopup(hc_popupContent, { 
				maxWidth: "auto"  // Makes sure popups accomadate photos 
			});
				
			//CREATE SIXTH SITE//		// Kildonan Dykes 
			var site_six  = turf.point([-1.754213,53.804011 ]);               // Turf point
			let inner_geofence6 = turf.buffer(site_six, 0.1 , {units:'miles', steps:32});   // Add inner buffer 
			let outer_geofence6 = turf.buffer(site_six, 0.1,{units: 'miles', steps:32});    // Add outer buffer
			var kd = L.marker([53.804011,-1.754213], {icon: kildonandykes}).bindPopup("Kildonan Dykes").addTo(map);  // Add custom icon
			L.geoJSON(inner_geofence6).addTo(map); 										// Add inner buffer to map 
			L.geoJSON(outer_geofence6, {style: myStyle}).addTo(map); 				// Add outer buffer to map using style defined above 
			//Create content for Kildonan Dykes 
			var kd_popupContent = ("<b> Well done! You found Kildonan Dykes! </b> <p>Long rocks</p> <img src= 'dykes.jpg'/>")   //Add content using HTML tags 
			var kd_popup = kd.bindPopup(kd_popupContent, { 
				maxWidth: "auto"  // Makes sure popups accomadate photos 
			});



			
			// CALL LOCATION FUNCTION 		
			map.on('locationfound', onLocationFound); 
			
			// ADD FAILED GEOLOCATION FUNCTION 
			function onLocationError(e) {     // Add function in the event of failed geolocation //seems to work even if location is found ? 
				alert(e.message); 
			} 
			map.on('locationerror', onLocationError); 
			
			//ADD LEGEND 
			L.control.Legend({           // Add legend to map 
				position: "bottomright", 
				collapsed: true,      // Collapse legend into small icon to be expanded 
				legends: [{ 
					label : "Goatfell", 
					type: "image", 
					url: "mountain.png",  
				},{ 
					label: "Drumadoon Sill", 
					type: "image", 
					url: "moher-cliffs.png", 
				},{ 
					label: "Corrie Sandstone", 
					type: "image", 
					url: "zen-rocks-stack.png", 
				},{ 
					label: "Glen Rosa", 
					type: "image", 
					url: "river.png",
				},{ 
					label: "Hutton's Unconformity", 
					type: "image", 
					url: "tower.png", 
				},{ 
					label: "Kildonan Dykes", 
					type: "image", 
					url: "sunset.png",
				}]
			}).addTo(map); 
	</script>
	</body>
</html>